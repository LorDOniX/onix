<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">onix.factory(&quot;$select&quot;, [
	&quot;$common&quot;,
	&quot;$event&quot;,
	&quot;$dom&quot;,
function(
	$common,
	$event,
	$dom
) {
<span id='$select'>	/**
</span>	 * $select uses bootstrap dropdown and provides additional functionality.
	 *
	 * @class $select
	 * @param {HTMLElement} el Where element has class &quot;dropdown&quot;
	 * @param {Object} [opts]
	 * @param {Boolean} [opts.addCaption = false] Add caption to select
	 * @member $select
	 */
	var $select = function(el, opts) {
		// event init
		this._eventInit();
		
		this._opts = {
			addCaption: false
		};

		for (var key in opts) {
			this._opts[key] = opts[key];
		}

		this._CONST = {
			CAPTION_SEL: &quot;.dropdown-toggle&quot;,
			OPTIONS_SEL: &quot;.dropdown-menu a&quot;,
			CARET_SEL: &quot;.caret&quot;,
			OPEN_DROPDOWN_SEL: &quot;.dropdown.open&quot;,
			OPEN_CLASS: &quot;open&quot;,
			ACTIVE_CLASS: &quot;active&quot;
		};

		this._el = el;

		this._optinsRef = [];
		this._captionEl = null;
		this.captionTextEl = null;

		this._binds = {
			captionClick: $common.bindWithoutScope(this._captionClick, this),
			choiceClick: $common.bindWithoutScope(this._choiceClick, this),
			removeAllOpened: this._removeAllOpened.bind(this),
			click: this._click.bind(this)
		};

		this._bind();
	};

<span id='$select-property-'>	/**
</span>	 * Extend $select with events functionality.
	 */
	$common.inherit($select, $event);

<span id='$select-method-_bind'>	/**
</span>	 * Bind clicks on the select.
	 *
	 * @member $select
	 * @private
	 */
	$select.prototype._bind = function() {
		this._bindCaption();
		this._bindChoices();
	};

<span id='$select-method-_bindCaption'>	/**
</span>	 * Bind caption el.
	 * 
	 * @member $select
	 * @private
	 */
	$select.prototype._bindCaption = function() {
		var captionEl = this._el.querySelector(this._CONST.CAPTION_SEL);

		if (captionEl) {
			// click on the caption
			captionEl.addEventListener(&quot;click&quot;, this._binds.captionClick);

			// insert span placeholder for caption
			if (this._opts.addCaption) {
				var caretEl = captionEl.querySelector(this._CONST.CARET_SEL);

				if (caretEl) {
					var captionTextEl = $dom.create({
						el: &quot;span&quot;,
						&quot;class&quot;: &quot;add-caption&quot;
					});

					captionEl.insertBefore(captionTextEl, caretEl);

					this._captionTextEl = captionTextEl;
				}
			}
		}

		this._captionEl = captionEl;
	};

<span id='$select-method-_removeAllOpened'>	/**
</span>	 * Remove all opened selectors -&gt; close all.
	 *
	 * @member $select
	 * @private
	 */
	$select.prototype._removeAllOpened = function() {
		var con = this._CONST;
		
		// remove all
		onix.element(con.OPEN_DROPDOWN_SEL).forEach(function(item) {
			item.classList.remove(con.OPEN_CLASS);
		});
	};

<span id='$select-method-_click'>	/**
</span>	 * Outside click.
	 * 
	 * @member $select
	 * @private
	 */
	$select.prototype._click = function() {
		this._removeAllOpened();
		document.removeEventListener(&quot;click&quot;, this._binds.click);
	};

<span id='$select-method-_captionClick'>	/**
</span>	 * Event - click on caption.
	 * 
	 * @param  {Event} e 
	 * @param  {Object} scope
	 * @member $select
	 * @private
	 */
	$select.prototype._captionClick = function(e, scope) {
		e.stopPropagation();

		var isOpen = scope._el.classList.contains(scope._CONST.OPEN_CLASS);

		scope._binds.removeAllOpened();

		if (isOpen) {
			// outside click
			document.removeEventListener(&quot;click&quot;, scope._binds.click);
		}
		else {
			// outside click
			document.addEventListener(&quot;click&quot;, scope._binds.click);

			scope._el.classList.add(scope._CONST.OPEN_CLASS);
		}
	};

<span id='$select-method-_bindChoices'>	/**
</span>	 * Bind choices inside select.
	 *
	 * @member $select
	 * @private
	 */
	$select.prototype._bindChoices = function() {
		onix.element(this._CONST.OPTIONS_SEL, this._el).forEach(function(option) {
			option.addEventListener(&quot;click&quot;, this._binds.choiceClick);

			// event ref
			this._optinsRef.push({
				el: option,
				event: &quot;click&quot;,
				fn: this._binds.choiceClick
			});
		}, this);
	};

<span id='$select-method-_choiceClick'>	/**
</span>	 * Event - click on option.
	 * 
	 * @param  {Event} e 
	 * @param  {Object} scope
	 * @member $select
	 * @private
	 */
	$select.prototype._choiceClick = function(e, scope) {
		var con = scope._CONST;

		e.stopPropagation();

		if (!this.parentNode.classList.contains(con.ACTIVE_CLASS)) {
			// remove previously selected
			var active = this.parentNode.parentNode.querySelector(&quot;.&quot; + con.ACTIVE_CLASS);
			
			if (active) {
				active.classList.remove(con.ACTIVE_CLASS);
			}

			// add to the current
			this.parentNode.classList.add(con.ACTIVE_CLASS);

			scope._el.classList.remove(con.OPEN_CLASS);

			if (scope._opts.addCaption &amp;&amp; scope._captionTextEl) {
				scope._captionTextEl.innerHTML = this.innerHTML;
			}

			// trigger click
			var value = this.getAttribute(&quot;data-value&quot;) || &quot;&quot;;
			scope.trigger(&quot;change&quot;, value);
		}
	};

<span id='$select-method-unbindChoices'>	/**
</span>	 * Unbind choices.
	 *
	 * @member $select
	 */
	$select.prototype.unbindChoices = function() {
		if (this._optinsRef.length) {
			this._optinsRef.forEach(function(option) {
				option.el.removeEventListener(option.event, option.fn);
			});

			this._optinsRef = [];
		}
	};

<span id='$select-method-rebindChoices'>	/**
</span>	 * Rebind choices.
	 *
	 * @member $select
	 */
	$select.prototype.rebindChoices = function() {
		this.unbindChoices();
		this._bindChoices();
	};

<span id='$select-method-selectOption'>	/**
</span>	 * Select option from the select.
	 * 
	 * @param {Number} ind Position 0..n
	 * @member $select
	 */
	$select.prototype.selectOption = function(ind) {
		ind = ind || 0;

		var optionsCount = this._optinsRef.length;

		if (optionsCount &gt; 0 &amp;&amp; ind &gt;= 0 &amp;&amp; ind &lt; optionsCount) {
			var el = this._optinsRef[ind].el;
			var parent = this._optinsRef[ind].el.parentNode;

			if (!parent.classList.contains(this._CONST.ACTIVE_CLASS)) {
				parent.classList.add(this._CONST.ACTIVE_CLASS);

				if (this._opts.addCaption &amp;&amp; this._captionTextEl) {
					this._captionTextEl.innerHTML = el.innerHTML;
				}

				// trigger click
				var value = el.getAttribute(&quot;data-value&quot;) || &quot;&quot;;
				this.trigger(&quot;change&quot;, value);
			}
		}
	};

<span id='$select-method-setAddCaption'>	/**
</span>	 * Set add caption from the current value.
	 *
	 * @member $select
	 */
	$select.prototype.setAddCaption = function() {
		if (!this._opts.addCaption) return;

		this._optinsRef.every(function(item) {
			var parent = item.el.parentNode;

			if (parent.classList.contains(this._CONST.ACTIVE_CLASS)) {
				this._captionTextEl.innerHTML = item.el.innerHTML;
				return false;
			}
			else return true;
		}, this);
	};

	return $select;
}]);
</pre>
</body>
</html>
