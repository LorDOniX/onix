<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">onix = (function() {
<span id='TYPES'>	/**
</span>	 * Module/app types
	 * @const
	 */
	var TYPES = {
		SERVICE: 1,
		FACTORY: 2,
		CONSTANT: 3,
		RUN: 4
	};

<span id='$$module'>	/**
</span>	 * $$module item
	 * @class $$module
	 * 
	 */
	var $$module = function() {
		this._allObj = [];
	};

<span id='$$module-method-service'>	/**
</span>	 * Add a new service
	 *
	 * @public
	 * @param  {String} name
	 * @param  {Array|Function} param With DI
	 * @memberof $$module
	 */
	$$module.prototype.service = function(name, param) {
		this._allObj.push({
			name: name,
			param: param,
			type: TYPES.SERVICE
		});
	};

<span id='$$module-method-factory'>	/**
</span>	 * Add a new factory
	 *
	 * @public
	 * @param  {String} name
	 * @param  {Array|Function} param With DI
	 * @memberof $$module
	 */
	$$module.prototype.factory = function(name, param) {
		this._allObj.push({
			name: name,
			param: param,
			type: TYPES.FACTORY
		});
	};

<span id='$$module-method-constant'>	/**
</span>	 * Add new constant
	 * 
	 * @public
	 * @param  {String} name
	 * @param  {Object} param
	 * @memberof onix
	 */
	$$module.prototype.constant = function(name, obj) {
		this._allObj.push({
			name: name,
			param: obj,
			type: TYPES.CONSTANT
		});
	};

<span id='$$module-method-run'>	/**
</span>	 * Add a new run
	 * 
	 * @public
	 * @param  {Array|Function} param With DI
	 * @memberof $$module
	 */
	$$module.prototype.run = function(param) {
		this._allObj.push({
			param: param,
			type: TYPES.RUN
		});
	};

<span id='$$module-method-config'>	/**
</span>	 * Read/add a config
	 * 
	 * @public
	 * @param  {Object|String} obj
	 * @memberof $$module
	 */
	$$module.prototype.config = function(obj) {
		// read/write ?
		var o = onix.config(obj);

		// if read -&gt; return output o
		if (o) {
			return o;
		}
	};

<span id='$$module-method-getAllObjects'>	/**
</span>	 * Get all objects in the module.
	 * 
	 * @public
	 * @return {Object}
	 * @memberof $$module
	 */
	$$module.prototype.getAllObjects = function() {
		return this._allObj;
	};

<span id='$$inject'>	/**
</span>	 * Dependency injection
	 *
	 * @class $$inject
	 */
	var $$inject = function(allObjects) {
		this._objects = allObjects;
	};

<span id='$$inject-method-bind'>	/**
</span>	 * Dependency injection bind
	 *
	 * @private
	 * @param  {Function|Array} param
	 * @param  {Object} [replace]
	 * @return {Object}
	 * @memberof $$inject
	 */
	$$inject.prototype.bind = function(param, replace) {
		var fn;
		var args = [];

		replace = replace || {};

		if (Array.isArray(param)) {
			param.every(function(item) {
				if (typeof item === &quot;function&quot;) {
					fn = item;
					return false;
				}
				else {
					args.push(item in replace ? replace[item] : this._objects[item]);
				}

				return true;
			}, this);
		}
		else {
			fn = param;
		}

<span id='$$inject-method-'>		/**
</span>		 * Run new binded function - with the new
		 * @param  {Function|Object} [scope] 
		 * @param  {Boolean} [callWithNew] 
		 * @return {Function}
		 */
		return function(scope, callWithNew) {
			if (callWithNew) {
				return new (Function.prototype.bind.apply(scope || fn, [null].concat(args)))
			}
			else {
				return fn.apply(scope || fn, args);
			}
		};
	};

<span id='onix'>	/**
</span>	 * Main framework object.
	 * 
	 * @class onix
	 */
	var onix = {
<span id='onix-property-_allObj'>		/**
</span>		 * All objects
		 *
		 * @private
		 * @type {Array}
		 * @memberof onix
		 */
		_allObj: [],

<span id='onix-property-_objects'>		/**
</span>		 * All processed objects
		 *
		 * @private
		 * @type {Object}
		 * @memberof onix
		 */
		_objects: {},

<span id='onix-property-_modules'>		/**
</span>		 * All modules
		 *
		 * @private
		 * @type {Object}
		 * @memberof onix
		 */
		_modules: {},

<span id='onix-property-_CONFIG_NAME'>		/**
</span>		 * Config name
		 *
		 * @private
		 * @const
		 * @memberof onix
		 */
		_CONFIG_NAME: &quot;$config&quot;,

<span id='onix-property-_DI_NAME'>		/**
</span>		 * DI name
		 *
		 * @private
		 * @const
		 * @memberof onix
		 */
		_DI_NAME: &quot;$inject&quot;,

<span id='onix-method-_init'>		/**
</span>		 * Init function
		 *
		 * @private
		 * @memberof onix
		 */
		_init: function() {
			// pred DOM loadem
			this._objects[this._CONFIG_NAME] = {};

			document.addEventListener(&quot;DOMContentLoaded&quot;, this._domLoad.bind(this));
		},

<span id='onix-method-_domLoad'>		/**
</span>		 * Event - Dom LOAD
		 *
		 * @private
		 * @memberof onix
		 */
		_domLoad: function() {
			// create DI
			var $inject = new $$inject(this._objects);

			this._objects[this._DI_NAME] = $inject;

			// process all inner items
			this._allObj.forEach(function(item) {
				// only 2 types
				switch (item.type) {
					case TYPES.SERVICE:
						this._objects[item.name] = $inject.bind(item.param)(null, true);
						break;

					case TYPES.FACTORY:
						this._objects[item.name] = $inject.bind(item.param)();
						break;
				}
			}, this);

			// delete them
			this._allObj.length = 0;

			var runs = [];

			// process all modules
			Object.keys(this._modules).forEach(function(moduleName) {
				var module = this._modules[moduleName].module;

				module.getAllObjects().forEach(function(moduleItem) {
					// modules have more types
					switch (moduleItem.type) {
						case TYPES.SERVICE:
							this._objects[moduleItem.name] = $inject.bind(moduleItem.param)(null, true);
							break;

						case TYPES.FACTORY:
							this._objects[moduleItem.name] = $inject.bind(moduleItem.param)();
							break;

						case TYPES.CONSTANT:
							this._objects[moduleItem.name] = moduleItem.param;
							break;

						case TYPES.RUN:
							runs.push(moduleItem);
							break;
					}
				}, this);
			}, this);

			// onix main run
			$inject.bind(this._run)(this);

			var $q = this.getObject(&quot;$q&quot;);
			var _promise = this.getObject(&quot;$$promise&quot;);
			var all = [];

			// run all runs
			runs.forEach(function(run) {
				var runO = $inject.bind(run.param)();

				// returns a promise
				if (runO &amp;&amp; runO instanceof _promise) {
					all.push(runO);
				}
			}, this);

			var $route = this.getObject(&quot;$route&quot;);

			if (all.length) {
				$q.all(all)[&quot;finally&quot;](function() {
					// route go
					$route.go();
				});
			}
			else {
				// route go
				$route.go();
			}
		},

<span id='onix-property-_run'>		/**
</span>		 * Main access point in the framework
		 *
		 * @private
		 * @memberof onix
		 */
		_run: [
			&quot;$i18n&quot;,
			&quot;$template&quot;,
			&quot;$loader&quot;,
			&quot;$route&quot;,
			&quot;$myQuery&quot;,
		function(
			$i18n,
			$template,
			$loader,
			$route,
			$myQuery
		) {
			// binds
			this.element = function(value, parent) {
				return new $myQuery.get(value, parent);
			};

			// inits
			$loader.init();
			$route.init();
			$template.init();

			// language
			window._ = $i18n._.bind($i18n);
		}],

<span id='onix-method-config'>		/**
</span>		 * Read/add config to the onix application.
		 *
		 * @public
		 * @param  {Object|String} obj
		 * @memberof onix
		 */
		config: function(obj) {
			if (typeof obj === &quot;string&quot;) {
				// obj is key
				return this._objects[this._CONFIG_NAME][obj];
			}
			else if (typeof obj === &quot;object&quot;) {
				Object.keys(obj).forEach(function(key) {
					this._objects[this._CONFIG_NAME][key] = obj[key];
				}.bind(this));
			}
		},

<span id='onix-method-service'>		/**
</span>		 * Add service to the application.
		 *
		 * @public
		 * @param  {String} name 
		 * @param  {Function|Array} param
		 * @memberof onix
		 */
		service: function(name, param) {
			this._allObj.push({
				name: name,
				param: param,
				type: TYPES.SERVICE
			});
		},

<span id='onix-method-factory'>		/**
</span>		 * Add factory to the application.
		 *
		 * @public
		 * @param  {String} name 
		 * @param  {Function|Array} param
		 * @memberof onix
		 */
		factory: function(name, param) {
			this._allObj.push({
				name: name,
				param: param,
				type: TYPES.FACTORY
			});
		},

<span id='onix-method-module'>		/**
</span>		 * Add module to the application.
		 *
		 * @public
		 * @param  {String} name 
		 * @return {$$module}
		 * @memberof onix
		 */
		module: function(name) {
			var module = new $$module();

			this._modules[name] = {
				module: module
			};

			return module;
		},

<span id='onix-method-getObject'>		/**
</span>		 * Get object
		 *
		 * @public
		 * @param  {String} name
		 * @return {Function|Object} 
		 * @memberof onix
		 */
		getObject: function(name) {
			name = name || &quot;&quot;;

			return this._objects[name];
		},

<span id='onix-method-getAllObjects'>		/**
</span>		 * Get all objects
		 *
		 * @public
		 * @return {Object}
		 * @memberof onix
		 */
		getAllObjects: function() {
			return this._objects;
		},

<span id='onix-method-noop'>		/**
</span>		 * Empty function
		 *
		 * @public
		 * @memberof onix
		 */
		noop: function() {

		},

<span id='onix-method-info'>		/**
</span>		 * Framework info.
		 *
		 * @public
		 * @memberof onix
		 */
		info: function() {
			console.log(
				&quot;Onix JS Framework\n&quot; +
				&quot;Version: 2.1.0\n&quot; +
				&quot;Date: 15. 7. 2015&quot;
			);
		}
	};

	// init app
	onix._init();

	return onix;
})();
</pre>
</body>
</html>
