<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">onix = (function() {
<span id='onix'>	/**
</span>	 * Main framework object.
	 * 
	 * @class onix
	 */
	var onix = function() {
<span id='onix-property-_objects'>		/**
</span>		 * All objects
		 *
		 * @type {Object}
		 * @member onix
		 * @private
		 */
		this._objects = {};

<span id='onix-property-_runs'>		/**
</span>		 * All run objects
		 *
		 * @type {Object}
		 * @member onix
		 * @private
		 */
		this._runs = [];

<span id='onix-property-_configs'>		/**
</span>		 * All config objectss
		 *
		 * @type {Object}
		 * @member onix
		 * @private
		 */
		this._configs = [];

<span id='onix-property-_CONST'>		/**
</span>		 * Constants: provider name and types
		 *
		 * @property {Object}
		 * @type {Object}
		 * @member onix
		 * @private
		 */
		this._CONST = {
			PROVIDER_NAME: &quot;Provider&quot;,
			TYPE: {
				PROVIDER: 1,
				SERVICE: 2,
				FACTORY: 3,
				CONSTANT: 4,
				VALUE: 5,
				CONFIG: 6,
				RUN: 7
			}
		};

		// bind DOM ready
		document.addEventListener(&quot;DOMContentLoaded&quot;, this._domLoad.bind(this));
	};

<span id='onix-method-_parseParam'>	/**
</span>	 * Parse param for injections and function
	 * 
	 * @param  {Array|Function} param
	 * @return {Object} Parsed object
	 */
	onix.prototype._parseParam = function(param) {
		var fn;
		var inject = [];

		if (Array.isArray(param)) {
			param.every(function(item) {
				if (typeof item === &quot;function&quot;) {
					fn = item;
					return false;
				}
				else if (typeof item === &quot;string&quot;) {
					inject.push(item);
				}

				return true;
			}, this);
		}
		else {
			fn = param;
		}

		return {
			fn: fn,
			inject: inject
		}
	};

<span id='onix-method-_domLoad'>	/**
</span>	 * Event - Dom LOAD
	 *
	 * @member onix
	 * @private
	 */
	onix.prototype._domLoad = function() {
		// promise -&gt; runs
		this._configs.forEach(function(config) {
			this._run(config, true);
		}, this);

		this._runs.forEach(function(run) {
			this._run(run);
		}, this);
	};

<span id='onix-method-_run'>	/**
</span>	 * Run object configuration; returns his cache (data)
	 * 
	 * @param  {Object}  obj Object configuration
	 * @param  {Boolean} isConfig Is config phase?
	 * @return {Object}
	 */
	onix.prototype._run = function(obj, isConfig) {
		var inject = [];

		if (obj.provider) {
			var providerObj = this._objects[obj.provider];

			if (!providerObj.cache) {
				var providerFn = providerObj.fn || this.noop;
				providerObj.cache = new providerFn();
			}

			var getFn = providerObj.cache[&quot;$get&quot;] || this.noop;
			var pp = this._parseParam(getFn);

			obj.fn = pp.fn;
			obj.inject = pp.inject;

			delete obj.provider;
		}

		if (obj.inject &amp;&amp; obj.inject.length) {
			obj.inject.forEach(function(objName) {
				var injObj = this._objects[objName];

				inject.push(this._run(injObj, isConfig));
			}, this);
		}

		// config phase
		if (isConfig) {
			switch (obj.type) {
				case this._CONST.TYPE.PROVIDER:
					if (!obj.cache) {
						var fn = obj.fn || this.noop;
						obj.cache = new fn();
					}

					return obj.cache;
					break;

				case this._CONST.TYPE.CONSTANT:
					return obj.cache;
					break;

				case this._CONST.TYPE.CONFIG:
					var fn = obj.fn || this.noop;
					obj.cache = fn.apply(fn, inject);
					break;

				default:
					return null;
			}
		}
		// run phase
		else {
			switch (obj.type) {
				case this._CONST.TYPE.FACTORY:
					if (!obj.cache) {
						var fn = obj.fn || this.noop;
						obj.cache = fn.apply(fn, inject);
					}

					return obj.cache;
					break;

				case this._CONST.TYPE.SERVICE:
					if (!obj.cache) {
						var fn = obj.fn || this.noop;
						var serviceObj = Object.create(fn.prototype);
						fn.apply(serviceObj, inject);
						obj.cache = serviceObj;
					}
					
					return obj.cache;
					break;

				case this._CONST.TYPE.VALUE:
					return obj.cache;
					break;

				case this._CONST.TYPE.CONSTANT:
					return obj.cache;
					break;

				case this._CONST.TYPE.RUN:
					var fn = obj.fn || this.noop;
					obj.cache = fn.apply(fn, inject);
					break;

				default:
					return null;
			}
		}
	};

<span id='onix-method-provider'>	/**
</span>	 * Add service to the application.
	 *
	 * @param  {String} name 
	 * @param  {Function} param
	 * @member onix
	 */
	onix.prototype.provider = function(name, param) {
		var pp = this._parseParam(param);

		this._objects[name + this._CONST.PROVIDER_NAME] = {
			name: name + this._CONST.PROVIDER_NAME,
			inject: pp.inject,
			fn: pp.fn,
			cache: null,
			type: this._CONST.TYPE.PROVIDER
		};

		this._objects[name] = {
			name: name,
			inject: null,
			fn: null,
			cache: null,
			provider: name + this._CONST.PROVIDER_NAME,
			type: this._CONST.TYPE.FACTORY
		};
	};

<span id='onix-method-service'>	/**
</span>	 * Add service to the application.
	 *
	 * @param  {String} name 
	 * @param  {Function|Array} param
	 * @member onix
	 */
	onix.prototype.service = function(name, param) {
		var pp = this._parseParam(param);

		this._objects[name] = {
			name: name,
			inject: pp.inject,
			fn: pp.fn,
			cache: null,
			type: this._CONST.TYPE.SERVICE
		};
	};

<span id='onix-method-factory'>	/**
</span>	 * Add factory to the application.
	 *
	 * @param  {String} name 
	 * @param  {Function|Array} param
	 * @member onix
	 */
	onix.prototype.factory = function(name, param) {
		var pp = this._parseParam(param);

		this._objects[name] = {
			name: name,
			inject: pp.inject,
			fn: pp.fn,
			cache: null,
			type: this._CONST.TYPE.FACTORY
		};
	};

<span id='onix-method-constant'>	/**
</span>	 * Add new constant
	 * 
	 * @param  {String} name
	 * @param  {Object} param
	 * @member onix
	 */
	onix.prototype.constant = function(name, obj) {
		this._objects[name] = {
			name: name,
			cache: obj,
			type: this._CONST.TYPE.CONSTANT
		};
	};

<span id='onix-method-value'>	/**
</span>	 * Add new value
	 * 
	 * @param  {String} name
	 * @param  {Object} param
	 * @member onix
	 */
	onix.prototype.value = function(name, obj) {
		this._objects[name] = {
			name: name,
			cache: obj,
			type: this._CONST.TYPE.VALUE
		};
	};

<span id='onix-method-config'>	/**
</span>	 * Add a new config
	 * 
	 * @param  {Array|Function} param With DI
	 * @member onix
	 */
	onix.prototype.config = function(param) {
		var pp = this._parseParam(param);

		this._configs.push({
			fn: pp.fn,
			inject: pp.inject,
			type: this._CONST.TYPE.CONFIG
		});
	};

<span id='onix-method-run'>	/**
</span>	 * Add a new run
	 * 
	 * @param  {Array|Function} param With DI
	 * @member onix
	 */
	onix.prototype.run = function(param) {
		var pp = this._parseParam(param);

		this._runs.push({
			fn: pp.fn,
			inject: pp.inject,
			type: this._CONST.TYPE.RUN
		});
	};

<span id='onix-method-noop'>	/**
</span>	 * Empty function
	 *
	 * @member onix
	 */
	onix.prototype.noop = function() {

	};

<span id='onix-method-info'>	/**
</span>	 * Framework info.
	 *
	 * @member onix
	 */
	onix.prototype.info = function() {
		console.log(
			&quot;OnixJS framework\n&quot; +
			&quot;2.2.2/27. 4. 2016\n&quot; +
			&quot;source: https://gitlab.com/LorDOniX/onix\n&quot; +
			&quot;documentation: https://gitlab.com/LorDOniX/onix/tree/master/docs&quot;
		);
	};

	return new onix()
})();
</pre>
</body>
</html>
