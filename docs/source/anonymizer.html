<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">onix.factory(&quot;$anonymizer&quot;, [
	&quot;$dom&quot;,
	&quot;$event&quot;,
	&quot;$loader&quot;,
	&quot;$q&quot;,
	&quot;$common&quot;,
function(
	$dom,
	$event,
	$loader,
	$q,
	$common
) {
<span id='$anonymizer'>	/**
</span>	 * Anonymizer - canvas for image preview with posibility for add geometries.
	 *
	 * @param {HTMLElement} parent Where is canvas appended
	 * @param {Object} [optsArg] Configuration
	 * @param {Number} [optsArg.canWidth] Canvas width
	 * @param {Number} [optsArg.canHeight] Canvas height
	 * @param {Number} [optsArg.zoom = 100] start zoom in [%]
	 * @param {Number} [optsArg.minZoom = 20] min zoom in [%]
	 * @param {Number} [optsArg.maxZoom = 100] max zoom in [%]
	 * @param {Number} [optsArg.zoomStep = 10] o kolik [%] How many [%] add/dec with zoom change
	 * @param {Number} [optsArg.zoomMoveStep = 1] Under 100% multiplier for faster image movement
	 * @param {Object} [optsArg.curEntity = $anonymizer.ENTITES.CIRCLE] Start entity from $anonymizer.ENTITES
	 * @param {Number} [optsArg.showPreview = true] Show preview - image overview
	 * @param {Number} [optsArg.previewLeft = 17] Preview location from left top corner, axe x [px]
	 * @param {Number} [optsArg.previewTop = 17] Preview location from left top corner, axe y [px]
	 * @param {Number} [optsArg.previewWidth = 200] Preview image width [px]
	 * @param {HTMLElement} [optsArg.entityPreview = null] Create entity preview? Parent for append.
	 * @class $anonymizer
	 */
	var $anonymizer = function(parent, optsArg) {
		// is canvas available?
		this._hasCanvas = !!document.createElement(&quot;canvas&quot;).getContext;

		if (!this._hasCanvas) {
			console.error(&quot;Canvas is not available!&quot;);
			return null;
		}

		// parent reference
		this._parent = parent;
		this._parent.classList.add(&quot;anonymizer&quot;);

		this._opts = {
			canWidth: parent.offsetWidth || 0,
			canHeight: parent.offsetHeight || 0,
			zoom: 100,
			minZoom: 20,
			maxZoom: 100,
			zoomStep: 10,
			zoomMoveStep: 1,
			curEntity: $anonymizer.ENTITES.CIRCLE,
			showPreview: true,
			previewLeft: 17,
			previewTop: 17,
			previewWidth: 200,
			entityPreview: null
		};

		for (var key in optsArg) {
			this._opts[key] = optsArg[key];
		}

		// canvas width &amp; height
		this._canWidth = this._opts.canWidth;
		this._canHeight = this._opts.canHeight;

		// zoom
		this._zoom = this._opts.zoom;
		// zoom step
		this._zoomStep = this._opts.zoomStep;
		// step for zoom move
		this._zoomMoveStep = 0;

		// act. image width
		this._curWidth = 0;
		// act. image height
		this._curHeight = 0;

		// create main canvas
		this._canvas = document.createElement(&quot;canvas&quot;);
		this._canvas.width = this._canWidth;
		this._canvas.height = this._canHeight;

		// ctx of main canvas
		this._ctx = this._canvas.getContext(&quot;2d&quot;);
		// loaded image
		this._img = null;

		// original image width
		this._imgWidth = 0;
		// original image height
		this._imgHeight = 0;

		// canvas &amp; ctx for create line
		this._lineCanvas = null;
		this._lineCanvasCtx = null;

		// canvas &amp; ctx for preview of a entity
		this._entityCanvas = null;
		this._entityCanvasCtx = null;

		// entites to draw
		this._entites = [];

		// image draw offset axe x
		this._x = 0;

		// image draw offset axe y
		this._y = 0;

		// threshold for click
		this._THRESHOLD = {
			MIN: -1,
			MAX: 1
		};

		// helper for mouse event
		this._mouse = {
			startXSave: 0,
			startYSave: 0,
			startX: 0,
			startY: 0
		};

		this._flags = {
			wasRightClick: false,
			wasMove: false,
			wasPreview: false,
			wasLine: false,
			wasImgMove: false
		};

		// binds
		this._binds = {
			mouseWheel: this._mouseWheel.bind(this),
			mouseDown: this._mouseDown.bind(this),
			mouseMove: this._mouseMove.bind(this),
			mouseUp: this._mouseUp.bind(this),
			mouseMoveLine: this._mouseMoveLine.bind(this),
			mouseUpLine: this._mouseUpLine.bind(this),
			mouseUpDocument: this._mouseUpDocument.bind(this),
			contextMenu: this._contextmenu.bind(this)
		};

		// firefox
		this._canvas.addEventListener(&quot;DOMMouseScroll&quot;, this._binds.mouseWheel);
		// others
		this._canvas.addEventListener(&quot;mousewheel&quot;, this._binds.mouseWheel);
		this._canvas.addEventListener(&quot;mousedown&quot;, this._binds.mouseDown);
		this._canvas.addEventListener(&quot;contextmenu&quot;, this._binds.contextMenu);

		// spinner - progress for image load
		this._spinner = $loader.getSpinner();
		parent.appendChild(this._spinner);
		parent.appendChild(this._canvas);

		// preview canvas
		if (this._opts.entityPreview) {
			this._entityCanvas = document.createElement(&quot;canvas&quot;);
			this._entityCanvas.width = 300;
			this._entityCanvas.height = 150;
			this._entityCanvasCtx = this._entityCanvas.getContext(&quot;2d&quot;);

			this._opts.entityPreview.appendChild(this._entityCanvas);
		}
	};

<span id='$anonymizer-property-'>	/**
</span>	 * Extend $anonymizer with events functionality.
	 */
	$common.inherit($anonymizer, $event);

<span id='$anonymizer-static-property-ENTITES'>	/**
</span>	 * List of entites.
	 * 
	 * @type {Object}
	 * @param {Object} CIRCLE Circle entity
	 * @param {Object} LINE Line entity
	 * @member $anonymizer
	 * @static
	 */
	$anonymizer.ENTITES = {
		CIRCLE: {
			min: 10,
			value: 50,
			max: 100,
			id: &quot;CIRCLE&quot;,
			fillStyle: &quot;rgba(0, 0, 255, 0.5)&quot;,
			priority: 1
		},
		LINE: {
			min: 10,
			value: 20,
			max: 100,
			id: &quot;LINE&quot;,
			strokeStyle: &quot;rgba(0, 255, 0, 0.5)&quot;,
			priority: 2
		}
	};

<span id='$anonymizer-method-_redraw'>	/**
</span>	 * Scene redraw - clear, picture, entites.
	 *
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._redraw = function() {
		// pictue
		this._ctx.clearRect(0, 0, this._canWidth, this._canHeight);
		this._ctx.drawImage(this._img, this._x, this._y, this._img.width, this._img.height, 0, 0, this._curWidth, this._curHeight);

		// entites
		if (this._entites.length) {
			var zc = this._zoom / 100;
			var xc = this._x * zc;
			var yc = this._y * zc;

			this._entites.forEach(function(entity) {
				switch (entity.id) {
					case $anonymizer.ENTITES.CIRCLE.id:
						var radius = Math.round(entity.value * zc);
						var x = Math.round(this._curWidth * entity.xRatio - xc);
						var y = Math.round(this._curHeight * entity.yRatio - yc);

						this._drawCircle(this._ctx, x, y, radius);
						break;

					case $anonymizer.ENTITES.LINE.id:
						var lineWidth = Math.round(entity.value * zc);
						var x = Math.round(this._curWidth * entity.xRatio - xc);
						var y = Math.round(this._curHeight * entity.yRatio - yc);
						var x2 = Math.round(this._curWidth * entity.x2Ratio - xc);
						var y2 = Math.round(this._curHeight * entity.y2Ratio - yc);

						this._drawLine(this._ctx, x, y, x2, y2, lineWidth);
						break;
				}
			}, this);
		}

		// image preview
		this._drawPreview();
	};

<span id='$anonymizer-method-_setWhiteCanvas'>	/**
</span>	 * Draw white canvas.
	 * 
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._setWhiteCanvas = function() {
		this._ctx.clearRect(0, 0, this._canWidth, this._canHeight);
		this._drawFillRect(this._ctx, 0, 0, this._canWidth, this._canHeight, &quot;#fff&quot;);
	};

<span id='$anonymizer-method-_drawCircle'>	/**
</span>	 * Draw a circle.
	 * 
	 * @param  {Canvas} ctx Canvas context
	 * @param  {Number} x Center coordinates axe x
	 * @param  {Number} y Center coordinates axe y
	 * @param  {Number} radius Circle radius
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._drawCircle = function(ctx, x, y, radius) {
		ctx.beginPath();
		ctx.arc(x, y, radius, 0, 2*Math.PI);
		ctx.fillStyle = $anonymizer.ENTITES.CIRCLE.fillStyle;
		ctx.closePath();
		ctx.fill();
	};

<span id='$anonymizer-method-_drawLine'>	/**
</span>	 * Draw a line.
	 * 
	 * @param  {Canvas} ctx Canvas context
	 * @param  {Number} x Line start coordinates axe x
	 * @param  {Number} y Line start coordinates axe y
	 * @param  {Number} x2 Line end coordinates axe x
	 * @param  {Number} y2 Line end coordinates axe y
	 * @param  {Number} lineWidth Line width [px]
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._drawLine = function(ctx, x, y, x2, y2, lineWidth) {
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.lineTo(x2, y2);
		ctx.lineWidth = lineWidth;
		ctx.strokeStyle = $anonymizer.ENTITES.LINE.strokeStyle;
		ctx.closePath();
		ctx.stroke();
	};

<span id='$anonymizer-method-_drawFillRect'>	/**
</span>	 * Draw a filled rectangle.
	 * 
	 * @param  {Canvas} ctx Canvas context
	 * @param  {Number} x Start coordinates axe x
	 * @param  {Number} y Start coordinates axe y
	 * @param  {Number} width Rectangle width
	 * @param  {Number} height Rectangle height
	 * @param  {String} fillStyle Fill style
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._drawFillRect = function(ctx, x, y, width, height, fillStyle) {
		ctx.beginPath();
		ctx.fillStyle = fillStyle || &quot;&quot;;
		ctx.fillRect(x, y, width, height);
		ctx.closePath();
	};

<span id='$anonymizer-method-_drawRect'>	/**
</span>	 * Draw a rectangle, only border.
	 * 
	 * @param  {Canvas} ctx Canvas context
	 * @param  {Number} x Start coordinates axe x
	 * @param  {Number} y Start coordinates axe y
	 * @param  {Number} width Rectangle width
	 * @param  {Number} height Rectangle height
	 * @param  {String} strokeStyle Border style
	 * @param  {Number} lineWidth Border width
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._drawRect = function(ctx, x, y, width, height, strokeStyle, lineWidth) {
		ctx.beginPath();
		ctx.rect(x, y, width, height);
		ctx.lineWidth = lineWidth || 1;
		ctx.strokeStyle = strokeStyle || &quot;&quot;;
		ctx.closePath();
		ctx.stroke();
	};

<span id='$anonymizer-method-_drawPreview'>	/**
</span>	 * Draw a image preview.
	 *
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._drawPreview = function() {
		if (!this._opts.showPreview) return;

		var ratio = this._imgWidth / this._imgHeight;
		var height = Math.round(this._opts.previewWidth / ratio);

		// background
		this._drawFillRect(this._ctx, this._opts.previewLeft - 1, this._opts.previewTop - 1, this._opts.previewWidth + 2, height + 2, &quot;rgba(255, 255, 255, 0.5)&quot;);

		// picture
		this._ctx.drawImage(this._img, 0, 0, this._img.width, this._img.height, this._opts.previewLeft, this._opts.previewTop, this._opts.previewWidth, height);

		// red border - current view
		var zc = this._zoom / 100;
		var xc = this._x * zc;
		var yc = this._y * zc;

		var xRatio = xc / this._curWidth;
		var yRatio = yc / this._curHeight;
		var x2Ratio = (xc + this._canWidth) / this._curWidth;
		var y2Ratio = (yc + this._canHeight) / this._curHeight;

		// restrictions
		xRatio = this._setRange(xRatio, 0, 1);
		yRatio = this._setRange(yRatio, 0, 1);
		x2Ratio = this._setRange(x2Ratio, 0, 1);
		y2Ratio = this._setRange(y2Ratio, 0, 1);

		var x1 = Math.round(this._opts.previewLeft + xRatio * this._opts.previewWidth);
		var y1 = Math.round(this._opts.previewTop + yRatio * height);
		var x2 = Math.round(this._opts.previewLeft + x2Ratio * this._opts.previewWidth);
		var y2 = Math.round(this._opts.previewTop + y2Ratio * height);

		// red border
		this._drawRect(this._ctx, x1, y1, x2 - x1, y2 - y1, &quot;#C01&quot;, 1);
	};

<span id='$anonymizer-method-_drawEntityPreview'>	/**
</span>	 * Draw a entity preview for circle/line.
	 *
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._drawEntityPreview = function() {
		if (!this._opts.entityPreview) return;

		var width = this._entityCanvas.width;
		var height = this._entityCanvas.height;

		this._entityCanvasCtx.clearRect(0, 0, width, height);
		this._drawFillRect(this._entityCanvasCtx, 0, 0, width, height, &quot;#f9f9f9&quot;);

		var curEnt = this._opts.curEntity;
		var zc = this._zoom / 100;

		switch (curEnt.id) {
			case $anonymizer.ENTITES.CIRCLE.id:
				var radius = Math.round(curEnt.value * zc);
				var x = Math.round(width / 2);
				var y = Math.round(height / 2);

				this._drawCircle(this._entityCanvasCtx, x, y, radius);
				break;

			case $anonymizer.ENTITES.LINE.id:
				var x1 = Math.round(width * 0.2);
				var y1 = Math.round(height / 2);
				var x2 = Math.round(width * 0.8);
				// y2 = y1
				var lineWidth = Math.round(curEnt.value * zc);

				this._drawLine(this._entityCanvasCtx, x1, y1, x2, y1, lineWidth);
				break;
		}
	};

<span id='$anonymizer-method-_getFromPoint'>	/**
</span>	 * Get center point for zoom, otherwise is used point with mouse wheel and cursor position.
	 *
	 * @param {Number} [x] Coordinates on canvas axe x, otherwise is used center point on axe x
	 * @param {Number} [y] Coordinates on canvas axe y, otherwise is used center point on axe y
	 * @return {Object}
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._getFromPoint = function(x, y) {
		var fromPoint = {
			x: x || Math.round(this._canWidth / 2),
			y: y || Math.round(this._canHeight / 2)
		};

		var zc = this._zoom / 100;
		var x = Math.round(this._x * zc) + fromPoint.x;
		var y = Math.round(this._y * zc) + fromPoint.y;

		fromPoint.xRatio = x / this._curWidth;
		fromPoint.yRatio = y / this._curHeight;

		return fromPoint;
	};

<span id='$anonymizer-method-_postZoom'>	/**
</span>	 * Post zoom operation - new image dimenstions, new move zoom step.
	 * 
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._postZoom = function() {
		var zc = this._zoom / 100;

		this._curWidth = Math.round(this._img.width * zc);
		this._curHeight = Math.round(this._img.height * zc);

		if (this._zoom &lt; 100) {
			// function for zoom and mouse move
			this._zoomMoveStep = Math.max(((100 - this._zoom) / 10 * this._opts.zoomMoveStep) / 2, 1);
		}
	};

<span id='$anonymizer-method-_setRange'>	/**
</span>	 * Set value in selected range.
	 * 
	 * @param {Number} value Input value
	 * @param {Number} min Min value
	 * @param {Number} max Max value
	 * @return {Number}
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._setRange = function(value, min, max) {
		if (value &lt; min) {
			return min;
		}
		else if (value &gt; max) {
			return max;
		}
		else {
			return value;
		}
	};

<span id='$anonymizer-method-_setCenter'>	/**
</span>	 * Set image center on the canvas center.
	 *
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._setCenter = function() {
		this._setPosition(0.5, 0.5);
	};
	
<span id='$anonymizer-method-_setPosition'>	/**
</span>	 * Set image offset position.
	 * 
	 * @param {Number} xRatio &lt;0;1&gt; Point position on the image
	 * @param {Number} yRatio &lt;0;1&gt; Point position on the image
	 * @param {Number} [x] Screen offset, otherwise center [px], axe x
	 * @param {Number} [y] Screen offset, otherwise center [px], axe y
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._setPosition = function(xRatio, yRatio, x, y) {
		x = x || this._canWidth / 2;
		y = y || this._canHeight / 2;

		xRatio = this._setRange(xRatio, 0, 1);
		yRatio = this._setRange(yRatio, 0, 1);

		var zc = this._zoom / 100;
		var xc = (this._curWidth * xRatio) - x;
		var yc = (this._curHeight * yRatio) - y;

		this._x = Math.max(Math.round(xc / zc), 0);
		this._y = Math.max(Math.round(yc / zc), 0);
	};

<span id='$anonymizer-method-_alignImgToCanvas'>	/**
</span>	 * Align image to the canvas - left top corner and bottom right corner.
	 *
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._alignImgToCanvas = function() {
		var maxX = Math.max(this._curWidth - this._canWidth, 0);
		var currX = Math.round(this._x * this._zoom / 100);

		if (this._x &lt; 0) {
			this._x = 0;
		}
		else if (currX &gt; maxX) {
			this._x = Math.round(maxX * 100 / this._zoom);
		}

		var maxY = Math.max(this._curHeight - this._canHeight, 0);
		var currY = Math.round(this._y * this._zoom / 100);

		if (this._y &lt; 0) {
			this._y = 0;
		}
		else if (currY &gt; maxY) {
			this._y = Math.round(maxY * 100 / this._zoom);
		}
	};

<span id='$anonymizer-method-_isRightClick'>	/**
</span>	 * It event contains right mouse click?
	 *
	 * @param {Event} e Mouse event
	 * @return {Boolean}
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._isRightClick = function(e) {
		if (e &amp;&amp; ((e.which &amp;&amp; e.which == 3) || (e.button &amp;&amp; e.button == 2))) {
			return true;
		}
		else {
			return false;
		}
	};

<span id='$anonymizer-method-_contextmenu'>	/**
</span>	 * Disable context menu for canvas during right mouse click.
	 * 
	 * @param  {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._contextmenu = function(e) {
		e.stopPropagation();
		e.preventDefault();
	};

<span id='$anonymizer-method-_mouseWheel'>	/**
</span>	 * Mouse wheel event.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseWheel = function(e) {
		if (!this._imgWidth &amp;&amp; !this._imgHeight) return;

		var delta = e.wheelDelta || -e.detail;
		if (!delta) { return; }

		e.stopPropagation();
		e.preventDefault();

		var fromPoint = this._getFromPoint(e.offsetX, e.offsetY);

		if (delta &gt; 0) {
			this._setZoom(this._zoom + this._zoomStep, fromPoint);
		}
		else {
			this._setZoom(this._zoom - this._zoomStep, fromPoint);
		}
	};

<span id='$anonymizer-method-_mouseDown'>	/**
</span>	 * Mouse down - create a circle, start of the line, start of move.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseDown = function(e) {
		if (!this._imgWidth &amp;&amp; !this._imgHeight) return;

		e.stopPropagation();
		e.preventDefault();

		this._mouse.startXSave = e.offsetX;
		this._mouse.startYSave = e.offsetY;
		this._mouse.startX = e.offsetX;
		this._mouse.startY = e.offsetY;
		this._flags.wasMove = false;
		this._flags.wasRightClick = this._isRightClick(e);

		// circle
		if (this._opts.curEntity == $anonymizer.ENTITES.CIRCLE) {
			this._flags.wasImgMove = false;
			this._flags.wasPreview = false;

			this._canvas.addEventListener(&quot;mousemove&quot;, this._binds.mouseMove);
			this._canvas.addEventListener(&quot;mouseup&quot;, this._binds.mouseUp);
			this._canvas.addEventListener(&quot;mouseleave&quot;, this._binds.mouseUp);
		}
		// line
		else if (this._opts.curEntity == $anonymizer.ENTITES.LINE) {
			// add canvas
			var lineCanvas = document.createElement(&quot;canvas&quot;);
			lineCanvas.width = this._canWidth;
			lineCanvas.height = this._canHeight;
			lineCanvas.classList.add(&quot;line-canvas&quot;);

			this._flags.wasPreview = false;
			this._flags.wasLine = false;

			this._lineCanvas = lineCanvas;
			this._lineCanvas.addEventListener(&quot;mousemove&quot;, this._binds.mouseMoveLine);
			this._lineCanvas.addEventListener(&quot;mouseup&quot;, this._binds.mouseUpLine);
			this._lineCanvas.addEventListener(&quot;contextmenu&quot;, this._binds.contextMenu);

			if (this._flags.wasRightClick) {
				this._lineCanvas.classList.add(&quot;is-dragged&quot;);
			}

			document.addEventListener(&quot;mouseup&quot;, this._binds.mouseUpDocument);

			this._lineCanvasCtx = this._lineCanvas.getContext(&quot;2d&quot;);

			this._parent.appendChild(lineCanvas);
		}
	};

<span id='$anonymizer-method-_imgMove'>	/**
</span>	 * Image move - according to the coordinates of the mouse.
	 * 
	 * @param  {Number} newX New value on the axe x
	 * @param  {Number} newY New value on the axe y
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._imgMove = function(newX, newY) {
		var diffX = this._mouse.startX - newX;
		var diffY = this._mouse.startY - newY;

		if (diffX == 0 &amp;&amp; diffY == 0) {
			return;
		}

		// image movement constant
		var zms = this._zoomMoveStep &gt; 0 ? this._zoomMoveStep : 1;

		// move image to the new coordinates
		this._x = diffX * zms + this._x;
		this._y = diffY * zms + this._y;

		this._alignImgToCanvas();
		this._redraw();
	};

<span id='$anonymizer-method-_mouseMove'>	/**
</span>	 * Mouse move over the canvas.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseMove = function(e) {
		// mouse cursor
		if (!this._flags.wasMove) {
			this._canvas.classList.add(&quot;is-dragged&quot;);
		}

		// mouse move flag
		this._flags.wasMove = true;

		// mouse move over the preview?
		var isPreview = this._isPreview(e.offsetX, e.offsetY);

		if (!this._flags.wasRightClick &amp;&amp; !this._flags.wasImgMove &amp;&amp; isPreview) {
			// set preview flag
			this._flags.wasPreview = true;

			// image move over the preview
			this._setPosition(isPreview.xRatio, isPreview.yRatio);

			this._alignImgToCanvas();
			this._redraw();
		}
		else if (!this._flags.wasPreview) {
			// image move - flag
			this._flags.wasImgMove = true;

			// image move
			this._imgMove(e.offsetX, e.offsetY);
		}

		// save
		this._mouse.startX = e.offsetX;
		this._mouse.startY = e.offsetY;
	};

<span id='$anonymizer-method-_isPreview'>	/**
</span>	 * Is there a preview on coordinates x, y?
	 * 
	 * @param  {Number} x Click position on canvas, axe x
	 * @param  {Number} y Click position on canvas, axe y
	 * @return {Object} Object with percent ration or null
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._isPreview = function(x, y) {
		if (!this._opts.showPreview) return null;

		var ratio = this._imgWidth / this._imgHeight;

		// sirka a vyska nahledu
		var width = this._opts.previewWidth;
		var height = Math.round(this._opts.previewWidth / ratio);

		var left = this._opts.previewLeft;
		var top = this._opts.previewTop;
		var zc = this._zoom / 100;

		x = x || 0;
		y = y || 0;

		if (x &gt;= left &amp;&amp; x &lt;= left + width &amp;&amp; y &gt;= top &amp;&amp; y &lt;= top + height) {
			return {
				xRatio: (x - left) / width,
				yRatio: (y - top) / height
			};
		}
		else {
			return null;
		}
	};

<span id='$anonymizer-method-_mouseUp'>	/**
</span>	 * Mouse up - draw a circle, end of move, preview click.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseUp = function(e) {
		var thresholdTest = false;

		// only it was move
		if (this._flags.wasMove) {
			// difference towards start click
			var diffX = this._mouse.startXSave - e.offsetX;
			var diffY = this._mouse.startYSave - e.offsetY;

			if (diffX &gt;= this._THRESHOLD.MIN &amp;&amp; diffX &lt;= this._THRESHOLD.MAX &amp;&amp; diffY &gt;= this._THRESHOLD.MIN &amp;&amp; diffY &lt;= this._THRESHOLD.MAX) {
				// we are in the range
				thresholdTest = true;
			}
		}

		// click - there was no move, threshold test, it is disabled for right mouse click
		if (!this._flags.wasRightClick &amp;&amp; (!this._flags.wasMove || thresholdTest)) {
			var isPreview = this._isPreview(e.offsetX, e.offsetY);

			if (isPreview) {
				// preview click - click coordinates on the canvas center
				this._setPosition(isPreview.xRatio, isPreview.yRatio);
				this._alignImgToCanvas();
				this._redraw();
			}
			else {
				// add circle
				var zc = this._zoom / 100;
				var x = Math.round(this._x * zc) + e.offsetX;
				var y = Math.round(this._y * zc) + e.offsetY;

				this._entites.push({
					id: this._opts.curEntity.id,
					value: this._opts.curEntity.value,
					xRatio: x / this._curWidth,
					yRatio: y / this._curHeight
				});

				this._redraw();
			}
		}

		this._canvas.classList.remove(&quot;is-dragged&quot;);

		this._canvas.removeEventListener(&quot;mousemove&quot;, this._binds.mouseMove);
		this._canvas.removeEventListener(&quot;mouseup&quot;, this._binds.mouseUp);
		this._canvas.removeEventListener(&quot;mouseleave&quot;, this._binds.mouseUp);
	};

<span id='$anonymizer-method-_mouseMoveLine'>	/**
</span>	 * Mouse move over canvas - line draw.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseMoveLine = function(e) {
		// mouse move
		this._flags.wasMove = true;

		// right mouse click
		if (this._flags.wasRightClick) {
			// image move
			this._imgMove(e.offsetX, e.offsetY);

			// save
			this._mouse.startX = e.offsetX;
			this._mouse.startY = e.offsetY;
		}
		// left mouse click
		else {
			var isPreview = this._isPreview(e.offsetX, e.offsetY);
			var wasPreview = this._flags.wasPreview;

			if (!this._flags.wasLine &amp;&amp; isPreview) {
				this._flags.wasPreview = true;

				// move over preview
				this._setPosition(isPreview.xRatio, isPreview.yRatio);
				this._alignImgToCanvas();
				this._redraw();
			}
			else if (!this._flags.wasPreview) {
				this._flags.wasLine = true;

				// line width
				var lineWidth = Math.round(this._opts.curEntity.value * this._zoom / 100);

				// clear
				this._lineCanvasCtx.clearRect(0, 0, this._canWidth, this._canHeight);
				// draw a line
				this._drawLine(this._lineCanvasCtx, this._mouse.startX, this._mouse.startY, e.offsetX, e.offsetY, lineWidth);
			}

			// change of state
			if (!wasPreview &amp;&amp; this._flags.wasPreview) {
				this._lineCanvas.classList.add(&quot;is-dragged&quot;);
			}
		}
	};

<span id='$anonymizer-method-_mouseUpLine'>	/**
</span>	 * End of move over canvas - create line, image move.
	 * Draw a line in main canvas.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseUpLine = function(e) {
		var isPreview = null;

		if (!this._flags.wasMove) {
			isPreview = this._isPreview(e.offsetX, e.offsetY);
		}

		// only for left mouse click
		if (!this._flags.wasRightClick) {
			if (isPreview) {
				// preview click - click coordinates on the canvas center
				this._setPosition(isPreview.xRatio, isPreview.yRatio);
				this._alignImgToCanvas();
				this._redraw();
			}
			else if (this._flags.wasLine) {
				// create a line
				var zc = this._zoom / 100;
				var xc = Math.round(this._x * zc);
				var yc = Math.round(this._y * zc);

				var x = xc + this._mouse.startX;
				var y = yc + this._mouse.startY;
				var x2 = xc + e.offsetX;
				var y2 = yc + e.offsetY;

				this._entites.push({
					id: this._opts.curEntity.id,
					value: this._opts.curEntity.value,
					xRatio: x / this._curWidth,
					yRatio: y / this._curHeight,
					x2Ratio: x2 / this._curWidth,
					y2Ratio: y2 / this._curHeight
				});

				this._redraw();
			}
		}

		this._lineCanvas.classList.remove(&quot;is-dragged&quot;);

		this._lineCanvas.removeEventListener(&quot;mousemove&quot;, this._binds.mouseMoveLine);
		this._lineCanvas.removeEventListener(&quot;mouseup&quot;, this._binds.mouseUpLine);
		this._lineCanvas.removeEventListener(&quot;contextmenu&quot;, this._binds.contextMenu);

		document.removeEventListener(&quot;mouseup&quot;, this._binds.mouseUpDocument);

		this._parent.removeChild(this._lineCanvas);

		this._lineCanvas = null;
	};

<span id='$anonymizer-method-_mouseUpDocument'>	/**
</span>	 * Mouse up over the document - drawing a line outside a canvas and mouse up -&gt; line is canceled.
	 *
	 * @param {Event} e Mouse event
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._mouseUpDocument = function(e) {
		this._flags.wasLine = false;
		this._mouseUpLine(e);
	};

<span id='$anonymizer-method-_setZoom'>	/**
</span>	 * Set new value for zoom.
	 * 
	 * @param  {Number} value New value
	 * @param  {Object} [fromPoint] Center of the screen or data from mouse wheel
	 * @private
	 * @member $anonymizer
	 */
	$anonymizer.prototype._setZoom = function(value, fromPoint) {
		var oldZoom = this._zoom;
		var newZoom = this._setRange(value, this._opts.minZoom, this._opts.maxZoom);

		if (newZoom == oldZoom) return;

		this._zoom = newZoom;
		this.trigger(&quot;zoom&quot;, this._zoom);
		this._postZoom();

		fromPoint = fromPoint || this._getFromPoint();
		
		this._setPosition(fromPoint.xRatio, fromPoint.yRatio, fromPoint.x, fromPoint.y);
		this._alignImgToCanvas();
		this._drawEntityPreview();
		this._redraw();
	};

<span id='$anonymizer-method-loadImage'>	/**
</span>	 * Load and show image in canvas. Returns promise after load.
	 * 
	 * @param  {String} url Path to image
	 * @return {$q} Promise
	 * @member $anonymizer
	 */
	$anonymizer.prototype.loadImage = function(url) {
		var promise = $q.defer();

		this._setWhiteCanvas();

		this._spinner.classList.remove(&quot;hide&quot;);

		var img = new Image();

		img.addEventListener(&quot;load&quot;, function() {
			this._spinner.classList.add(&quot;hide&quot;);
			this._img = img;
			this._imgWidth = img.width;
			this._imgHeight = img.height;
			this._zoom = this._opts.zoom;

			this.trigger(&quot;zoom&quot;, this._zoom);

			this._postZoom();
			this._setCenter();
			this._alignImgToCanvas();
			this._drawEntityPreview();
			this._redraw();

			promise.resolve();
		}.bind(this));

		img.addEventListener(&quot;error&quot;, function() {
			this._spinner.classList.add(&quot;hide&quot;);

			this._img = null;
			this._imgWidth = 0;
			this._imgHeight = 0;

			promise.reject();
		}.bind(this));

		img.src = url || &quot;&quot;;

		return promise;
	};

<span id='$anonymizer-method-zoomPlus'>	/**
</span>	 * Increase zoom by one step, fires signal &quot;zoom&quot;.
	 * 
	 * @member $anonymizer
	 */
	$anonymizer.prototype.zoomPlus = function() {
		this._setZoom(this._zoom + this._zoomStep);
	};

<span id='$anonymizer-method-zoomMinus'>	/**
</span>	 * Decrease zoom by one step, fires signal &quot;zoom&quot;.
	 * 
	 * @member $anonymizer
	 */
	$anonymizer.prototype.zoomMinus = function() {
		this._setZoom(this._zoom - this._zoomStep);
	};

<span id='$anonymizer-method-setZoom'>	/**
</span>	 * Set new value for zoom.
	 * 
	 * @param  {Number} value New value
	 * @member $anonymizer
	 */
	$anonymizer.prototype.setZoom = function(value) {
		this._setZoom(value);
	};

<span id='$anonymizer-method-getEntityId'>	/**
</span>	 * Get current draw entity ID.
	 * 
	 * @return {String}
	 * @member $anonymizer
	 */
	$anonymizer.prototype.getEntityId = function() {
		return this._opts.curEntity.id;
	};

<span id='$anonymizer-method-switchEntity'>	/**
</span>	 * Switch to other entity, uses priority.
	 *
	 * @member $anonymizer
	 */
	$anonymizer.prototype.switchEntity = function() {
		var variants = Object.keys($anonymizer.ENTITES);
		var priority = this._opts.curEntity.priority;
		var selVariant = null;
		var lowestVariant = null;

		variants.forEach(function(variant) {
			var varObj = $anonymizer.ENTITES[variant];

			if (!selVariant &amp;&amp; varObj.priority &gt; this._opts.curEntity.priority) {
				selVariant = varObj;
			}

			if (!lowestVariant || varObj.priority &lt; lowestVariant.priority) {
				lowestVariant = varObj;
			}
		}, this);

		if (!selVariant) {
			selVariant = lowestVariant;
		}

		this._opts.curEntity = selVariant;

		this._drawEntityPreview();
	};

<span id='$anonymizer-method-getEntity'>	/**
</span>	 * Get current entity object.
	 * 
	 * @return {Object}
	 * @member $anonymizer
	 */
	$anonymizer.prototype.getEntity = function() {
		return this._opts.curEntity;
	};

<span id='$anonymizer-method-setEntityValue'>	/**
</span>	 * Set value for current entity.
	 * 
	 * @param {Number} val New value
	 * @return {Boolean} If there was an error -&gt; it returns false
	 * @member $anonymizer
	 */
	$anonymizer.prototype.setEntityValue = function(val) {
		val = val || 0;

		if (val &gt;= this._opts.curEntity.min &amp;&amp; val &lt;= this._opts.curEntity.max) {
			this._opts.curEntity.value = val;
			this._drawEntityPreview();
			return true;
		}
		else {
			return false;
		}
	};

<span id='$anonymizer-method-setCircleEntity'>	/**
</span>	 * Set circle as a selected entity.
	 *
	 * @member $anonymizer
	 */
	$anonymizer.prototype.setCircleEntity = function() {
		this._opts.curEntity = $anonymizer.ENTITES.CIRCLE;
		this._drawEntityPreview();
	};

<span id='$anonymizer-method-setLineEntity'>	/**
</span>	 * Set line as a selected entity.
	 *
	 * @member $anonymizer
	 */
	$anonymizer.prototype.setLineEntity = function() {
		this._opts.curEntity = $anonymizer.ENTITES.LINE;
		this._drawEntityPreview();
	};

<span id='$anonymizer-method-stepBack'>	/**
</span>	 * Take last entity and redraw a scene.
	 * 
	 * @member $anonymizer
	 */
	$anonymizer.prototype.stepBack = function() {
		if (!this._imgWidth &amp;&amp; !this._imgHeight) return;
		
		this._entites.pop();
		this._redraw();
	};

<span id='$anonymizer-method-removeAll'>	/**
</span>	 * Remove all entites and redraw a scene.
	 * 
	 * @member $anonymizer
	 */
	$anonymizer.prototype.removeAll = function() {
		if (!this._imgWidth &amp;&amp; !this._imgHeight) return;

		this._entites = [];
		this._redraw();
	};

<span id='$anonymizer-method-exportEntites'>	/**
</span>	 * Export all entites on the screen and count them towards original image size.
	 * 
	 * @return {Object}
	 * @member $anonymizer
	 */
	$anonymizer.prototype.exportEntites = function() {
		var output = {
			actions: [],
			image: {
				width: this._imgWidth,
				height: this._imgHeight
			}
		};

		this._entites.forEach(function(entity) {
			switch (entity.id) {
				case $anonymizer.ENTITES.CIRCLE.id:
					output.actions.push({
						type: entity.id.toLowerCase(),
						x: Math.round(this._imgWidth * entity.xRatio),
						y: Math.round(this._imgHeight * entity.yRatio),
						r: entity.value
					});
					break;

				case $anonymizer.ENTITES.LINE.id:
					output.actions.push({
						type: entity.id.toLowerCase(),
						x1: Math.round(this._imgWidth * entity.xRatio),
						y1: Math.round(this._imgHeight * entity.yRatio),
						x2: Math.round(this._imgWidth * entity.x2Ratio),
						y2: Math.round(this._imgHeight * entity.y2Ratio),
						width: entity.value
					});
					break;
			}
		}, this);

		return output;
	};

<span id='$anonymizer-method-syncPort'>	/**
</span>	 * Resize canvas with new width and height.
	 * 
	 * @param  {Number} [width] New width in [px]
	 * @param  {Number} [height] New height in [px]
	 * @member $anonymizer
	 */
	$anonymizer.prototype.syncPort = function(width, height) {
		width = width || this._parent.offsetWidth;
		height = height || this._parent.offsetHeight;

		this._canWidth = width;
		this._canHeight = height;

		this._canvas.width = width;
		this._canvas.height = height;

		if (this._img) {
			this._postZoom();
			this._setCenter();
			this._alignImgToCanvas();
			this._drawEntityPreview();
			this._redraw();
		}
	};

	return $anonymizer;
}]);
</pre>
</body>
</html>
