<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='$previewImages'>/**
</span> * Class for creating img previews from File[] variable.
 * 
 * @class $previewImages
 */
onix.service(&quot;$previewImages&quot;, [
	&quot;$image&quot;,
	&quot;$dom&quot;,
	&quot;$job&quot;,
	&quot;$loader&quot;,
function(
	$image,
	$dom,
	$job,
	$loader
) {
<span id='$previewImages-method-_createPreview'>	/**
</span>	 * Create one image preview.
	 *
	 * @private
	 * @param  {File} file
	 * @param  {Number} [maxSize] Max image size
	 * @return {Object} dom references
	 * @member $previewImages
	 */
	this._createPreview = function(file, maxSize) {
		var exported = {};

		var cont = $dom.create({
			el: &quot;span&quot;,
			&quot;class&quot;: [&quot;preview-item&quot;, &quot;preview-loading&quot;],
			child: [{
				el: &quot;span&quot;,
				&quot;class&quot;: &quot;canvas-cover&quot;,
				child: [$loader.getSpinner(true)],
				style: &quot;height: &quot; + (maxSize || 100) + &quot;px&quot;,
				_exported: &quot;canvasCover&quot;
			}, {
				el: &quot;span&quot;,
				&quot;class&quot;: &quot;title&quot;,
				innerHTML: file.name.replace(/\..*/g, &quot;&quot;)
			}]
		}, exported);

		return {
			cont: cont,
			canvasCover: exported.canvasCover
		};
	};

<span id='$previewImages-method-_createPreviewHolders'>	/**
</span>	 * Create preview holders. Only for images count 4 and 7.
	 * Four images are in the one row, seven images has the last one above them.
	 *
	 * @private
	 * @param {HTMLElement} el
	 * @param {Number} count
	 * @member $previewImages
	 */
	this._createPreviewHolders = function(el, count) {
		if (!el || (count != 4 &amp;&amp; count != 7)) return;

		var exported = {};

		// placeholder for 7 images
		if (count == 7) {
			// ceiling line
			el.appendChild($dom.create({
				el: &quot;div&quot;,
				child: [{
					el: &quot;span&quot;,
					_exported: &quot;img_06&quot;
				}]
			}, exported));
		}

		var child = [];
		var childCount = count == 7 ? 6 : 4;

		for (var i = 0; i &lt; childCount; i++) {
			child.push({
				el: &quot;span&quot;,
				_exported: &quot;img_0&quot; + i
			});
		}

		// rest line
		el.appendChild($dom.create({
			el: &quot;div&quot;,
			child: child
		}, exported));

		for (var i = 0; i &lt; count; i++) {
			this._dom[&quot;img_0&quot; + i] = exported[&quot;img_0&quot; + i];
		}
	};

<span id='$previewImages-method-_jobTask'>	/**
</span>	 * One job task
	 *
	 * @private
	 * @param  {Object} previewObj Object with file and preview ID
	 * @param  {Number} maxSize Max image size in px
	 * @param  {Function} jobDone Function which indicates that job is done
	 */
	this._jobTask = function(previewObj, maxSize, jobDone) {
		var file = previewObj.file;
		var previewID = previewObj.previewID;
		var preview = this._createPreview(file, maxSize);
		
		// append
		if (previewID in this._dom) {
			this._dom[previewID].appendChild(preview.cont);
		}
		else {
			this._dom.previewItems.appendChild(preview.cont);
		}

		$image.readFromFile(file, maxSize).then(function(readFileObj) {
			preview.cont.classList.remove(&quot;preview-loading&quot;);
			preview.canvasCover.innerHTML = &quot;&quot;;
			preview.canvasCover.appendChild(readFileObj.canvas);

			jobDone();
		});
	};

<span id='$previewImages-method-show'>	/**
</span>	 * Main function for showing img previews.
	 * 
	 * @param  {HTMLElement} el Placeholder element
	 * @param  {File[]} files
	 * @param  {Object} [opts] Configuration
	 * @param  {Number} [opts.maxSize = 0] Max image size in px; the size is used for image scale
	 * @param  {Number} [opts.count = 0] How many images are processed simultinously
	 * @param  {Boolean} [opts.createHolder = false] Create placeholder, see _createPreviewHolders function
	 * @member $previewImages
	 */
	this.show = function(el, files, optsArg) {
		// clear previous
		el.innerHTML = &quot;&quot;;

		// add class
		el.classList.add(&quot;preview-images&quot;);

		var opts = {
			maxSize: 0,
			count: 0,
			createHolder: false
		};

		for (var key in optsArg) {
			opts[key] = optsArg[key];
		}

		this._dom = {
			previewItems: el
		};

		var pictureFiles = $image.getPictureFiles(files);
		var count = pictureFiles.length;

		if (count) {
			// create placeholder?
			if (opts.createHolder) {
				this._createPreviewHolders(el, count);
			}

			var jobsArray = [];

			// sort by name, make previewID - only for 7 pictures
			pictureFiles = pictureFiles.sort(function(a, b) {
				if (a.name &lt; b.name)
					return -1;
				else if (a.name &gt; b.name)
					return 1;
				else 
					return 0;
			}).forEach(function(pf, ind) {
				jobsArray.push({
					task: this._jobTask,
					scope: this,
					args: [{
						file: pf,
						previewID: &quot;img_0&quot; + ind
					}, opts.maxSize]
				});
			}, this);

			// run jobs array
			$job.multipleJobs(jobsArray, opts.count);
		}
	};
}]);
</pre>
</body>
</html>
