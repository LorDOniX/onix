<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">onix.factory(&quot;$crop&quot;, [
	&quot;$dom&quot;,
	&quot;$math&quot;,
function(
	$dom,
	$math
) {
<span id='$crop'>	/**
</span>	 *
	 * Crop - this class is used for selection crop above the image/element.
	 * 
	 * @param {Object} [options] Configuration
	 * @param {Number} [options.width = 250] Crop width
	 * @param {Number} [options.height = 250] Crop height
	 * @param {Number} [options.minWidth = 10] Crop min width, always higher than 0!
	 * @param {Number} [options.minHeight = 10] Crop min height, always higher than 0!
	 * @param {Number} [options.maxWidth = Infinity] Crop max width
	 * @param {Number} [options.maxHeight = Infinity] Crop max height
	 * @param {Boolean} [options.resizable = true] Crop can be resizabled by points
	 * @param {Number} [options.aspectRatio = 0] Crop aspect ratio for width / height
	 * @class $crop
	 */
	var $crop = function(options) {
		this._CONST = {
			HIDE_CLASS: &quot;hide&quot;
		};

		this._options = {
			width: 250, // initial size
			height: 250,
			minWidth: 10,
			minHeight: 10, //  if resizable=true
			maxWidth: Infinity,
			maxHeight: Infinity,
			resizable: true,
			aspectRatio: 0
		};

		for (var op in options) {
			this._options[op] = options[op];
		}

		// areas dimensions
		this._dim = {
			areaWidth: 0,
			areaHeight: 0,
			width: this._options.width,
			height: this._options.height
		};

		this._changed = false;

		this._backupData = null;

		this._groups = {
			&quot;point-nw&quot;: [{ type: &quot;nw&quot;, x: true, y: true }, { type: &quot;sw&quot;, x: true }, { type: &quot;ne&quot;, y: true }],
			&quot;point-ne&quot;: [{ type: &quot;ne&quot;, x: true, y: true }, { type: &quot;se&quot;, x: true }, { type: &quot;nw&quot;, y: true }],
			&quot;point-sw&quot;: [{ type: &quot;sw&quot;, x: true, y: true }, { type: &quot;nw&quot;, x: true }, { type: &quot;se&quot;, y: true }],
			&quot;point-se&quot;: [{ type: &quot;se&quot;, x: true, y: true }, { type: &quot;ne&quot;, x: true }, { type: &quot;sw&quot;, y: true }]
		};

		this._points = { nw: { x: 0, y: 0 }, ne: { x: 0, y: 0 }, sw: { x: 0, y: 0 }, se: { x: 0, y: 0 }};
		this._type = null;

		this._mouse = {
			startXSave: 0,
			startYSave: 0,
			startX: 0,
			startY: 0
		};

		this._binds = {
			mouseDown: this._mouseDown.bind(this),
			mouseMove: this._mouseMove.bind(this),
			mouseUp: this._mouseUp.bind(this)
		};

		this._dom = {};

		this._create();

		this._dom.container.addEventListener(&quot;mousedown&quot;, this._binds.mouseDown);

		// crop is by default hidden
		this.hide();
	};

<span id='$crop-method-_create'>	/**
</span>	 * Create crop element.
	 * 
	 * @return {Element}
	 * @member $crop
	 * @private
	 */
	$crop.prototype._create = function() {
		var cropClass = [&quot;crop&quot;];

		if (this._options.resizable) {
			cropClass.push(&quot;resizable&quot;);
		}

		$dom.create({
			el: &quot;div&quot;,
			&quot;class&quot;: cropClass,
			child: [{
				el: &quot;div&quot;,
				&quot;class&quot;: &quot;crop-top&quot;,
				child: [{
					el: &quot;span&quot;,
					&quot;class&quot;: &quot;point-nw&quot;
				}, {
					el: &quot;span&quot;,
					&quot;class&quot;: &quot;point-ne&quot;
				}],
				_exported: &quot;cropTop&quot;
			}, {
				el: &quot;div&quot;,
				&quot;class&quot;: &quot;crop-bottom&quot;,
				child: [{
					el: &quot;span&quot;,
					&quot;class&quot;: &quot;point-sw&quot;
				}, {
					el: &quot;span&quot;,
					&quot;class&quot;: &quot;point-se&quot;
				}],
				_exported: &quot;cropBottom&quot;
			}, {
				el: &quot;div&quot;,
				&quot;class&quot;: &quot;crop-left&quot;,
				_exported: &quot;cropLeft&quot;
			}, {
				el: &quot;div&quot;,
				&quot;class&quot;: &quot;crop-right&quot;,
				_exported: &quot;cropRight&quot;
			}, {
				el: &quot;div&quot;,
				&quot;class&quot;: &quot;crop-middle&quot;,
				_exported: &quot;cropMiddle&quot;
			}],
			_exported: &quot;container&quot;
		}, this._dom);
	};

<span id='$crop-method-_setCenter'>	/**
</span>	 * Set crop center above his area.
	 *
	 * @private
	 * @member $crop
	 */
	$crop.prototype._setCenter = function() {
		var width = this._dim.width;
		var height = this._dim.height;

		var leftDiff = Math.round((this._dim.areaWidth - width) / 2);
		var topDiff = Math.round((this._dim.areaHeight - height) / 2);

		var p = this._points;

		p.nw.x = leftDiff;
		p.nw.y = topDiff;

		p.ne.x = p.nw.x + width;
		p.ne.y = p.nw.y + height;

		p.sw.x = this._dim.areaWidth - leftDiff;
		p.sw.y = this._dim.areaHeight - topDiff;

		p.se.x = p.ne.x;
		p.se.y = p.ne.y;
	};

<span id='$crop-method-_alignPoints'>	/**
</span>	 * Align crop points inside his area.
	 * 
	 * @private
	 * @member $crop
	 */
	$crop.prototype._alignPoints = function() {
		var p = this._points;
		var w = this._dim.areaWidth - this._dim.width;
		var h = this._dim.areaHeight - this._dim.height;

		p.nw.x = $math.setRange(p.nw.x, 0, w);
		p.sw.x = $math.setRange(p.sw.x, 0, w);
		p.ne.x = $math.setRange(p.ne.x, this._dim.width, this._dim.areaWidth);
		p.se.x = $math.setRange(p.se.x, this._dim.width, this._dim.areaWidth);

		p.nw.y = $math.setRange(p.nw.y, 0, h);
		p.ne.y = $math.setRange(p.ne.y, 0, h);
		p.sw.y = $math.setRange(p.sw.y, this._dim.height, this._dim.areaHeight);
		p.se.y = $math.setRange(p.se.y, this._dim.height, this._dim.areaHeight);
	};

<span id='$crop-method-_redraw'>	/**
</span>	 * Redraw crop - calculate all his points and set them in dom objects.
	 * 
	 * @private
	 * @member $crop
	 */
	$crop.prototype._redraw = function() {
		var p = this._points;

		var leftX = p.nw.x;
		var leftY = p.nw.y;
		var size = this._getSize();

		this._dom.cropTop.style.left = leftX + &quot;px&quot;;
		this._dom.cropTop.style.width = size.width + &quot;px&quot;;
		this._dom.cropTop.style.height = leftY + &quot;px&quot;;

		this._dom.cropBottom.style.left = leftX + &quot;px&quot;;
		this._dom.cropBottom.style.width = size.width + &quot;px&quot;;
		this._dom.cropBottom.style.height = (this._dim.areaHeight - p.sw.y) + &quot;px&quot;;

		this._dom.cropLeft.style.width = leftX + &quot;px&quot;;
		this._dom.cropLeft.style.height = this._dim.areaHeight + &quot;px&quot;;

		this._dom.cropRight.style.width = (this._dim.areaWidth - p.ne.x) + &quot;px&quot;;
		this._dom.cropRight.style.height = this._dim.areaHeight + &quot;px&quot;;

		this._dom.cropMiddle.style.width = size.width + &quot;px&quot;;
		this._dom.cropMiddle.style.height = size.height + &quot;px&quot;;
		this._dom.cropMiddle.style.left = leftX + &quot;px&quot;;
		this._dom.cropMiddle.style.top = leftY + &quot;px&quot;;
	};

<span id='$crop-method-_mouseDown'>	/**
</span>	 * Mouse down - move/resize crop.
	 * 
	 * @param  {Event} e
	 * @private
	 * @member $crop
	 */
	$crop.prototype._mouseDown = function(e) {
		e.stopPropagation();
		e.preventDefault();

		// ie8
		var target = e.target || e.srcElement;

		this._type = target.getAttribute(&quot;class&quot;);

		switch (this._type) {
			case &quot;crop-top&quot;:
			case &quot;crop-bottom&quot;:
			case &quot;crop-left&quot;:
			case &quot;crop-right&quot;:
				return;
		}

		// save values during click
		this._mouse.startX = e.clientX;
		this._mouse.startY = e.clientY;
		this._mouse.startXSave = e.clientX;
		this._mouse.startYSave = e.clientY;

		document.addEventListener(&quot;mousemove&quot;, this._binds.mouseMove);
		document.addEventListener(&quot;mouseup&quot;, this._binds.mouseUp);
	};

<span id='$crop-method-_mouseMove'>	/**
</span>	 * Mouse move - move/resize crop.
	 * 
	 * @param  {Event} e
	 * @private
	 * @member $crop
	 */
	$crop.prototype._mouseMove = function(e) {
		e.stopPropagation();
		e.preventDefault();

		var diffX =  e.clientX - this._mouse.startX;
		var diffY = e.clientY - this._mouse.startY;

		if (this._type == &quot;crop-middle&quot;) {
			// move
			Object.keys(this._points).forEach(function(key) {
				this._points[key].x += diffX;
				this._points[key].y += diffY;
			}, this);

			this._alignPoints();
			this._redraw();
		}
		else {
			// resize - which group?
			var group = this._groups[this._type];

			if (this._options.aspectRatio) {
				diffY = diffX / this._options.aspectRatio * (this._type == &quot;point-nw&quot; || this._type == &quot;point-se&quot; ? 1 : -1);
			}

			if (this._resizeTest(diffX, diffY, group)) {
				group.forEach(function(i) {
					var point = this._points[i.type];

					// add diffx, diffy to all group members
					point.x += i.x ? diffX : 0;
					point.y += i.y ? diffY : 0;
				}, this);

				// update size
				var size = this._getSize();

				this._dim.width = size.width;
				this._dim.height = size.height;

				this._redraw();
			}
		}

		// overwrite
		this._mouse.startX = e.clientX;
		this._mouse.startY = e.clientY;
	};

<span id='$crop-method-_mouseUp'>	/**
</span>	 * Mouse up - end of move/resize crop.
	 * 
	 * @param  {Event} e
	 * @private
	 * @member $crop
	 */
	$crop.prototype._mouseUp = function(e) {
		e.stopPropagation();
		e.preventDefault();

		document.removeEventListener(&quot;mousemove&quot;, this._binds.mouseMove);
		document.removeEventListener(&quot;mouseup&quot;, this._binds.mouseUp);

		if (this._mouse.startXSave != e.clientX || this._mouse.startYSave != e.clientY) {
			// crop was changed
			this._changed = true;
		}
	};

<span id='$crop-method-_getSize'>	/**
</span>	 * Get size of crop.
	 * 
	 * @param  {Object} [points] Points object, default is used crop points.
	 * @return {Object}
	 * @member $crop
	 */
	$crop.prototype._getSize = function(points) {
		points = points || this._points;

		return {
			width: Math.abs(points.ne.x - points.nw.x),
			height: Math.abs(points.sw.y - points.nw.y)
		};
	};

<span id='$crop-method-_resizeTest'>	/**
</span>	 * Resize test - if returns false, crop size is on the edge of the area.
	 * 
	 * @param  {Number} diffX Increment on axe X
	 * @param  {Number} diffY Increment on axe Y
	 * @param  {Array[Object]} group Selected group from mouse down
	 * @return {Boolean} false - error
	 * @member $crop
	 */
	$crop.prototype._resizeTest = function(diffX, diffY, group) {
		if (!this._options.aspectRatio) {
			return false;
		}

		var points = {
			nw: {
				x: this._points.nw.x,
				y: this._points.nw.y
			},
			ne: {
				x: this._points.ne.x,
				y: this._points.ne.y
			},
			sw: {
				x: this._points.sw.x,
				y: this._points.sw.y
			},
			se: {
				x: this._points.se.x,
				y: this._points.se.y
			}
		}

		group.forEach(function(i) {
			var point = points[i.type];

			// add diffx, diffy to all group members
			point.x = this._points[i.type].x + (i.x ? diffX : 0);
			point.y = this._points[i.type].y + (i.y ? diffY : 0);
		}, this);

		// min. and max. value
		var size = this._getSize(points);

		// test
		if (
			size.width &lt; this._options.minWidth || size.width &gt; this._options.maxWidth ||
			size.height &lt; this._options.minHeight || size.height &gt; this._options.maxHeight ||
			points.nw.x &lt; 0 || points.se.x &gt; this._dim.areaWidth ||
			points.nw.y &lt; 0 || points.sw.y &gt; this._dim.areaHeight
		) {
			return false;
		}
		else {
			return true;
		}
	};

<span id='$crop-method-setCenter'>	/**
</span>	 * Set crop center above his area.
	 * 
	 * @member $crop
	 */
	$crop.prototype.setCenter = function() {
		this._setCenter();

		this._redraw();
	};

<span id='$crop-method-fitToArea'>	/**
</span>	 * Fit crop to whole area and center him on the screen.
	 * 
	 * @member $crop
	 */
	$crop.prototype.fitToArea = function() {
		var width;
		var height;

		if (this._options.aspectRatio) {
			var ratio = this._options.aspectRatio;

			// try width
			width = this._dim.areaWidth;
			height = Math.round(width / ratio);

			// try height
			if (height &gt; this._dim.areaHeight) {
				height = this._dim.areaHeight;
				width = Math.round(height * ratio);
			}
		}
		else {
			width = Math.min(this._options.maxWidth, this._dim.areaWidth);
			height = Math.min(this._options.maxHeight, this._dim.areaHeight);
		}
		
		// update dimensions
		this._dim.width = width;
		this._dim.height = height;

		// center and redraw
		this.setCenter();
	};

<span id='$crop-method-destroy'>	/**
</span>	 * Remove crop from DOM.
	 * 
	 * @member $crop
	 */
	$crop.prototype.destroy = function() {
		var c = this.getContainer();

		if (c.parentNode) {
			c.parentNode.removeChild(c);
		}

		this._dom.container.removeEventListener(&quot;mousedown&quot;, this._binds.mouseDown);
	};

<span id='$crop-method-getContainer'>	/**
</span>	 * Get crop root el.
	 * 
	 * @return {HTMLElement}
	 * @member $crop
	 */
	$crop.prototype.getContainer = function() {
		return this._dom.container;
	};

<span id='$crop-method-setDim'>	/**
</span>	 * Set crop area dimensions.
	 * 
	 * @param {Object} [dim]
	 * @param {Number} [dim.areaWidth] Area width
	 * @param {Number} [dim.areaHeight] Area height
	 * @member $crop
	 */
	$crop.prototype.setDim = function(dim) {
		dim = dim || {};

		if (dim.areaWidth) {
			this._dim.areaWidth = dim.areaWidth;

			this._dom.container.style.width = this._dim.areaWidth + &quot;px&quot;;
		}

		if (dim.areaHeight) {
			this._dim.areaHeight = dim.areaHeight;

			this._dom.container.style.height = this._dim.areaHeight + &quot;px&quot;;
		}
	};

<span id='$crop-method-show'>	/**
</span>	 * Show crop.
	 *
	 * @member $crop
	 */
	$crop.prototype.show = function() {
		this._dom.container.classList.remove(this._CONST.HIDE_CLASS);
	};

<span id='$crop-method-hide'>	/**
</span>	 * Hide crop.
	 *
	 * @member $crop
	 */
	$crop.prototype.hide = function() {
		this._dom.container.classList.add(this._CONST.HIDE_CLASS);
	};

<span id='$crop-method-isVisible'>	/**
</span>	 * Is crop visible?
	 * 
	 * @return {Boolean}
	 * @member $crop
	 */
	$crop.prototype.isVisible = function() {
		return !(this._dom.container.classList.contains(this._CONST.HIDE_CLASS));
	};

<span id='$crop-method-isChanged'>	/**
</span>	 * Is crop changed?
	 * 
	 * @return {Boolean}
	 * @member $crop
	 */
	$crop.prototype.isChanged = function() {
		return this._changed;
	};

<span id='$crop-method-backup'>	/**
</span>	 * Backup current crop state - his position and change state.
	 * 
	 * @member $crop
	 */
	$crop.prototype.backup = function() {
		this._backupData = {
			changed: this._changed,
			aabb: this.getAABB()
		};
	};

<span id='$crop-method-restore'>	/**
</span>	 * Restore crop saved state - his position and change state.
	 * 
	 * @member $crop
	 */
	$crop.prototype.restore = function() {
		if (this._backupData) {
			this._changed = this._backupData.changed;

			var aabb = this._backupData.aabb;

			var nw = this._points[&quot;nw&quot;];
			var ne = this._points[&quot;ne&quot;];
			var sw = this._points[&quot;sw&quot;];
			var se = this._points[&quot;se&quot;];

			// restore
			nw.x = aabb[0];
			nw.y = aabb[1];
			se.x = aabb[2];
			se.y = aabb[3];

			ne.x = se.x;
			ne.y = nw.y;
			sw.x = nw.x;
			sw.y = se.y;

			this._redraw();

			this._backupData = null;
		}
	};

<span id='$crop-method-getAABB'>	/**
</span>	 * Get crop bounding box.
	 * 
	 * @param {Number} [scale=1] Recalculate all positions using scale constants, def. is 1
	 * @return {Array} [x1, y1, x2, y2] 2 points coordinates from top left corner
	 * @member $crop
	 */
	$crop.prototype.getAABB = function(scale) {
		var nw = this._points[&quot;nw&quot;];
		var se = this._points[&quot;se&quot;];

		scale = scale || 1.0;

		return [
			Math.round(nw.x * scale),
			Math.round(nw.y * scale),
			Math.round(se.x * scale),
			Math.round(se.y * scale)
		];
	};

	return $crop;
}]);
</pre>
</body>
</html>
