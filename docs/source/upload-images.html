<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">onix.factory(&quot;$uploadImages&quot;, [
	&quot;$job&quot;,
	&quot;$q&quot;,
	&quot;$dom&quot;,
function(
	$job,
	$q,
	$dom
) {
<span id='$uploadImages'>	/**
</span>	 * @class $uploadImages
	 *
	 * Class for creating img previews from File[] variable
	 */
	var uploadImages = function() {
		this._disable = !(&quot;FileReader&quot; in window);

		this._const = {
			// max preview image height
			previewMaxSize: 180
		};
	};

<span id='$uploadImages-method-_doJobs'>	/**
</span>	 * Do jobs for processing all images
	 *
	 * @private
	 * @param  {Array} dataArray Array of files with images
	 * @param  {Function} fn Job task
	 * @param  {Number} count How many functions processed simultinously
	 * @param  {Function} taskDoneObj Callback after one task have been done
	 * @return {$q} Callback after all job is done
	 * @member $uploadImages
	 */
	uploadImages.prototype._doJobs = function(dataArray, fn, count, taskDoneObj) {
		var len = dataArray.length;
		var jobs = [];

		for (var i = 0; i &lt; len; i++) {
			var jp = i % count;

			if (!jobs[jp]) {
				jobs[jp] = $job.create();

				if (taskDoneObj) {
					jobs[jp].setTaskDone(taskDoneObj.cb, taskDoneObj.scope);
				}
			}

			jobs[jp].add(fn, this, dataArray[i]);
		}

		var jobPromises = [];

		jobs.forEach(function(job) {
			jobPromises.push(job.start());
		});

		return $q.all(jobPromises);
	};

<span id='$uploadImages-method-_isPicture'>	/**
</span>	 * Is file a picture?
	 *
	 * @private
	 * @param  {File}  file
	 * @return {Boolean}
	 * @member $uploadImages
	 */
	uploadImages.prototype._isPicture = function(file) {
		if (file) {
			return (file.type == &quot;image/jpeg&quot; || file.type == &quot;image/pjpeg&quot; || file.type == &quot;image/png&quot;);
		}
		else return false;
	};

<span id='$uploadImages-method-_readFile'>	/**
</span>	 * Read one file, create one preview
	 *
	 * @private
	 * @param  {Object} fileObj
	 * @param  {Object} fileObj.file File reference
	 * @param  {String} fileObj.previewID Preview ID for DOM position
	 * @param  {Function} doneFn Callback, after one preview is loaded and drawed to canvas
	 * @member $uploadImages
	 */
	uploadImages.prototype._readFile = function(fileObj, doneFn) {
		var file = fileObj.file;
		var previewID = fileObj.previewID;

		var fileObj = {
			file: file,
			exif: null,
			img: null
		};

		var preview = this._createPreview(file);
		
		// append
		if (previewID in this._dom) {
			this._dom[previewID].appendChild(preview.cont);
		}
		else {
			this._dom.previewItems.appendChild(preview.cont);
		}

		var reader = new FileReader();

		reader.onload = function(e) {
			var binaryData = reader.result;
			var binaryDataArray = new Uint8Array(binaryData);
			var exif = null;

			if (file.type != &quot;png&quot;) {
				exif = EXIF.readFromBinaryFile(binaryData);
			}

			var img = new Image();

			img.onload = function() {
				var imd = this._getImageDim(img);
				var canvas = this._processInputImage(img, imd, exif.Orientation);
				
				preview.cont.classList.remove(&quot;preview-loading&quot;);
				preview.canvasCover.innerHTML = &quot;&quot;;
				preview.canvasCover.appendChild(canvas);

				fileObj.exif = exif;
				fileObj.img = img;
				doneFn();
			}.bind(this);

			img.src = this._fileToBase64(file.type, binaryDataArray);
		}.bind(this);

		reader.readAsArrayBuffer(file);
	};

<span id='$uploadImages-method-_createPreview'>	/**
</span>	 * Create one image preview
	 *
	 * @private
	 * @param  {File} file
	 * @return {Object} dom references
	 * @member $uploadImages
	 */
	uploadImages.prototype._createPreview = function(file) {
		var exported = {};

		var cont = $dom.create({
			el: &quot;span&quot;,
			&quot;class&quot;: [&quot;preview-item&quot;, &quot;preview-loading&quot;],
			child: [{
				el: &quot;span&quot;,
				&quot;class&quot;: &quot;canvas-cover&quot;,
				child: [{
					el: &quot;img&quot;,
					&quot;class&quot;: &quot;preview-loader&quot;,
					src: &quot;/static/img/loading.gif&quot;
				}],
				_exported: &quot;canvasCover&quot;
			}, {
				el: &quot;span&quot;,
				&quot;class&quot;: &quot;title&quot;,
				innerHTML: file.name.replace(/\..*/g, &quot;&quot;)
			}]
		}, exported);

		return {
			cont: cont,
			canvasCover: exported.canvasCover
		};
	};

<span id='$uploadImages-method-_getImageDim'>	/**
</span>	 * Counts image dimension; if maxSize is available, new dimension is calculated
	 *
	 * @private
	 * @param  {Image} img
	 * @return {Object}
	 * @member $uploadImages
	 */
	uploadImages.prototype._getImageDim = function(img) {
		var maxSize = this._const.previewMaxSize;
		var largeWidth = img.width &gt; maxSize;
		var largeHeight = img.height &gt; maxSize;

		var output = {
			width: img.width,
			height: img.height,
			scale: 1,
			large: false
		};

		if (largeWidth || largeHeight) {
			// resizneme obrazek
			var imgWidth = img.width;
			var imgHeight = img.height;

			// vybereme vetsi ze stran
			if (img.width &gt; img.height) {
				// sirka
				imgHeight = maxSize * imgHeight / imgWidth;
				imgWidth = maxSize;
			}
			else {
				// vyska
				imgWidth = maxSize * imgWidth / imgHeight;
				imgHeight = maxSize;
			}

			output.scale = img.width / imgWidth; // pomer orig. a zmenseneho obrazku
			output.width = imgWidth;
			output.height = imgHeight;
			output.large = true;
		}

		return output;
	};

<span id='$uploadImages-method-_processInputImage'>	/**
</span>	 * Process image: rotate by exif, decrase size according to MAX SIZE
	 *
	 * @private
	 * @param  {Image} img
	 * @param  {Object} imd object dimension
	 * @param  {Number} orientation EXIF orientation
	 * @return {Canvas}
	 * @member $uploadImages
	 */
	uploadImages.prototype._processInputImage = function(img, imd, orientation) {
		var canvas = document.createElement(&quot;canvas&quot;);
		var ctx = canvas.getContext(&quot;2d&quot;);
		var draw = true;

		canvas.width = imd.width;
		canvas.height = imd.height;

		// rotate
		if (orientation) {
			switch (orientation) {
				case 2:
					// horizontal flip
					ctx.translate(imd.width, 0);
					ctx.scale(-1, 1);
					break;

				case 3:
					// 180° rotate left
					ctx.translate(imd.width, imd.height);
					ctx.rotate(Math.PI);
					break;

				case 4:
					// vertical flip
					ctx.translate(0, imd.height);
					ctx.scale(1, -1);
					break;

				case 5:
					// vertical flip + 90 rotate right
					canvas.width = imd.height;
					canvas.height = imd.width;
					ctx.rotate(0.5 * Math.PI);
					ctx.scale(1, -1);

					if (imd.large) {
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.height, canvas.width);
						draw = false;
					}
					break;

				case 6:
					// 90° rotate right
					canvas.width = imd.height;
					canvas.height = imd.width;
					ctx.rotate(0.5 * Math.PI);
					ctx.translate(0, -imd.height);
					
					if (imd.large) {
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.height, canvas.width);
						draw = false;
					}
					break;

				case 7:
					// horizontal flip + 90 rotate right
					canvas.width = imd.height;
					canvas.height = imd.width;
					ctx.rotate(0.5 * Math.PI);
					ctx.translate(imd.width, -imd.height);
					ctx.scale(-1, 1);

					if (imd.large) {
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.height, canvas.width);
						draw = false;
					}
					break;

				case 8:
					// 90° rotate left
					canvas.width = imd.height;
					canvas.height = imd.width;
					ctx.rotate(-0.5 * Math.PI);
					ctx.translate(-imd.width, 0);

					if (imd.large) {
						ctx.clearRect(0, 0, canvas.width, canvas.height);
						ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.height, canvas.width);
						draw = false;
					}
			}
		}

		if (draw) {
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			if (imd.large) {
				ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);
			}
			else {
				ctx.drawImage(img, 0, 0);
			}
		}

		return canvas;
	};

<span id='$uploadImages-method-_fileToBase64'>	/**
</span>	 * Binary data to base64
	 *
	 * @private
	 * @param  {String} fileType
	 * @param  {Array} binaryData
	 * @return {String}
	 * @member $uploadImages
	 */
	uploadImages.prototype._fileToBase64 = function(fileType, binaryData) {
		var length = binaryData.length
		var output = &quot;&quot;;

		for (var i = 0; i &lt; length; i += 1) {
			output += String.fromCharCode(binaryData[i]);
		}

		return &#39;data:&#39; + fileType + &#39;;base64,&#39; + btoa(output);
	};

<span id='$uploadImages-method-_createPreviewHolders'>	/**
</span>	 * Create preview holders.
	 *
	 * @private
	 * @param {HTMLElement} el
	 * @param {Number} count
	 * @member $uploadImages
	 */
	uploadImages.prototype._createPreviewHolders = function(el, count) {
		if (!el || (count != 4 &amp;&amp; count != 7)) return;

		var exported = {};

		// placeholder for panorama
		if (count == 7) {
			// ceiling line
			el.appendChild($dom.create({
				el: &quot;div&quot;,
				child: [{
					el: &quot;span&quot;,
					_exported: &quot;img_06&quot;
				}]
			}, exported));
		}

		var child = [];
		var childCount = count == 7 ? 6 : 4;

		for (var i = 0; i &lt; childCount; i++) {
			child.push({
				el: &quot;span&quot;,
				_exported: &quot;img_0&quot; + i
			});
		}

		// rest line
		el.appendChild($dom.create({
			el: &quot;div&quot;,
			child: child
		}, exported));

		for (var i = 0; i &lt; count; i++) {
			this._dom[&quot;img_0&quot; + i] = exported[&quot;img_0&quot; + i];
		}
	};

<span id='$uploadImages-method-show'>	/**
</span>	 * Main function for showing img previews.
	 * 
	 * @param  {HTMLElement} el
	 * @param  {File[]} files
	 * @member $uploadImages
	 */
	uploadImages.prototype.show = function(el, files) {
		if (this._disable || !el || !files) return;

		// clear previous
		el.innerHTML = &quot;&quot;;

		this._dom = {
			previewItems: el
		};

		var pictureFiles = this.getPictureFiles(files);
		var count = pictureFiles.length;

		if (count) {
			this._createPreviewHolders(el, count);

			// sort by name, make previewID - only for 7 pictures
			pictureFiles = pictureFiles.sort(function(a, b) {
				if (a.name &lt; b.name)
					return -1;
				else if (a.name &gt; b.name)
					return 1;
				else 
					return 0;
			}).map(function(file, ind) {
				return {
					file: file,
					previewID: &quot;img_0&quot; + ind
				};
			});

			this._doJobs(pictureFiles, this._readFile, 2);
		}
	};

<span id='$uploadImages-method-getPictureFiles'>	/**
</span>	 * Get picture files from array of files
	 * 
	 * @param  {Array} array of files
	 * @return {Array}
	 * @member $uploadImages
	 */
	uploadImages.prototype.getPictureFiles = function(files) {
		var pictureFiles = [];

		if (files &amp;&amp; files.length) {
			for (var i = 0; i &lt; files.length; i++) {
				var item = files[i];

				if (this._isPicture(item)) {
					pictureFiles.push(item);
				}
			}
		}

		return pictureFiles;
	};

<span id='$uploadImages-method-getPicturesCount'>	/**
</span>	 * Get picture files count from the array of Files. This function uses &#39;getPictureFiles&#39;
	 * 
	 * @param  {Array} array of files
	 * @return {Boolean}
	 * @member $uploadImages
	 */
	uploadImages.prototype.getPicturesCount = function(files) {
		return this.getPictureFiles(files).length;
	};

	return uploadImages;
}]);
</pre>
</body>
</html>
